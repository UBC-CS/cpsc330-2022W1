
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lecture 19: Survival analysis &#8212; CPSC 330 Applied Machine Learning</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lecture 20: Ethics" href="20_ethics.html" />
    <link rel="prev" title="Lecture 18: Time series" href="18_time-series.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/UBC-CS-logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">CPSC 330 Applied Machine Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Things you should know
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/README.html">
   CPSC 330 Documents
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Lectures
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_intro.html">
   Lecture 1: Course Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_decision-trees.html">
   Lecture 2: Terminology, Baselines, Decision Trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_ml-fundamentals.html">
   Lecture 3: Machine Learning Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_kNNs-SVM-RBF.html">
   Lecture 4:
   <span class="math notranslate nohighlight">
    \(k\)
   </span>
   -Nearest Neighbours and SVM RBFs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_preprocessing-pipelines.html">
   Lecture 5: Preprocessing and
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_column-transformer-text-feats.html">
   Lecture 6:
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   <code class="docutils literal notranslate">
    <span class="pre">
     ColumnTransformer
    </span>
   </code>
   and Text Features
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_linear-models.html">
   Lecture 7: Linear Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_hyperparameter-optimization.html">
   Lecture 8: Hyperparameter Optimization and Optimization Bias
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_classification-metrics.html">
   Lecture 9: Classification Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_regression-metrics.html">
   Lecture 10: Regression Evaluation Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_ensembles.html">
   Lecture 11: Ensembles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_feat-importances.html">
   Lecture 12: Feature importances
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_feature-engineering-selection.html">
   Lecture 13: Feature engineering and feature selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_k-means-clustering.html">
   Lecture 14: Clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_recommender-systems.html">
   Lecture 15: DBSCAN and Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_natural-language-processing.html">
   Lecture 16: Introduction to natural language processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_intro_to_computer-vision.html">
   Lecture 17: Multi-class classification and introduction to computer vision
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="18_time-series.html">
   Lecture 18: Time series
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Lecture 19: Survival analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="20_ethics.html">
   Lecture 20: Ethics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="21_communication.html">
   Lecture 21: Communication
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="22_deployment-conclusion.html">
   Lecture 22: Deployment and conclusion
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Attribution
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../attribution.html">
   Attributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../LICENSE.html">
   LICENSE
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Varada Kolhatkar, CPSC 330 2021-22<br>Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/lectures/19_survival-analysis.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/UBC-CS/cpsc330/master?urlpath=tree/lectures/19_survival-analysis.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#announcements">
   Announcements
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#learning-objectives">
   Learning objectives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#customer-churn-our-standard-approach-10-min">
   Customer churn: our standard approach (10 min)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dummyclassifier">
     DummyClassifier
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#logisticregression">
     LogisticRegression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#randomforestclassifier">
     RandomForestClassifier
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#censoring-and-survival-analysis-15-min">
   Censoring and survival analysis (15 min)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#time-to-event-and-censoring">
     Time to event and censoring
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#approach-1-only-consider-the-examples-where-churn-yes">
     Approach 1: Only consider the examples where “Churn”=Yes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#approach-2-assume-everyone-churns-right-now">
     Approach 2: Assume everyone churns right now
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#approach-3-survival-analysis">
     Approach 3: Survival analysis
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#types-of-questions-we-might-want-to-answer">
       Types of questions we might want to answer:
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#break-5-min">
   Break (5 min)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#kaplan-meier-survival-curve-10-min">
   Kaplan-Meier survival curve (10 min)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cox-proportional-hazards-model-10-min">
   Cox proportional hazards model (10 min)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prediction-10-min">
   Prediction (10 min)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluation">
   Evaluation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-approaches-what-did-we-not-cover-5-min">
   Other approaches / what did we not cover? (5 min)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#types-of-censoring">
     Types of censoring
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#true-false-questions">
   True/False questions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Lecture 19: Survival analysis</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#announcements">
   Announcements
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#learning-objectives">
   Learning objectives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#customer-churn-our-standard-approach-10-min">
   Customer churn: our standard approach (10 min)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dummyclassifier">
     DummyClassifier
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#logisticregression">
     LogisticRegression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#randomforestclassifier">
     RandomForestClassifier
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#censoring-and-survival-analysis-15-min">
   Censoring and survival analysis (15 min)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#time-to-event-and-censoring">
     Time to event and censoring
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#approach-1-only-consider-the-examples-where-churn-yes">
     Approach 1: Only consider the examples where “Churn”=Yes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#approach-2-assume-everyone-churns-right-now">
     Approach 2: Assume everyone churns right now
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#approach-3-survival-analysis">
     Approach 3: Survival analysis
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#types-of-questions-we-might-want-to-answer">
       Types of questions we might want to answer:
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#break-5-min">
   Break (5 min)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#kaplan-meier-survival-curve-10-min">
   Kaplan-Meier survival curve (10 min)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cox-proportional-hazards-model-10-min">
   Cox proportional hazards model (10 min)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prediction-10-min">
   Prediction (10 min)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluation">
   Evaluation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-approaches-what-did-we-not-cover-5-min">
   Other approaches / what did we not cover? (5 min)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#types-of-censoring">
     Types of censoring
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#true-false-questions">
   True/False questions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><img alt="" src="../_images/330-banner.png" /></p>
<div class="tex2jax_ignore mathjax_ignore section" id="lecture-19-survival-analysis">
<h1>Lecture 19: Survival analysis<a class="headerlink" href="#lecture-19-survival-analysis" title="Permalink to this headline">¶</a></h1>
<p>UBC 2020-21</p>
<p>Instructor: Varada Kolhatkar</p>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span><span class="p">,</span> <span class="n">make_column_transformer</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">plot_confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cross_val_predict</span><span class="p">,</span>
    <span class="n">cross_val_score</span><span class="p">,</span>
    <span class="n">cross_validate</span><span class="p">,</span>
    <span class="n">train_test_split</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FunctionTransformer</span><span class="p">,</span>
    <span class="n">OneHotEncoder</span><span class="p">,</span>
    <span class="n">OrdinalEncoder</span><span class="p">,</span>
    <span class="n">StandardScaler</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>

<span class="c1"># does lifelines try to mess with this?</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">lifelines</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="announcements">
<h2>Announcements<a class="headerlink" href="#announcements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>hw8 released, due December 7th 11:59pm</p></li>
<li><p>Next lecture on Ethics is likely to be a guest lecture by one of my colleagues who has taught Ethics in the MDS program.</p></li>
</ul>
</div>
<div class="section" id="learning-objectives">
<h2>Learning objectives<a class="headerlink" href="#learning-objectives" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Explain the problem with treating right-censored data the same as “regular” data.</p></li>
<li><p>Determine whether survival analysis is an appropriate tool for a given problem.</p></li>
<li><p>Apply survival analysis in Python using the <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> package.</p></li>
<li><p>Interpret a survival curve, such as the Kaplan-Meier curve.</p></li>
<li><p>Interpret the coefficients of a fitted Cox proportional hazards model.</p></li>
<li><p>Make predictions for existing individuals and interpret these predictions.</p></li>
</ul>
</div>
<div class="section" id="customer-churn-our-standard-approach-10-min">
<h2>Customer churn: our standard approach (10 min)<a class="headerlink" href="#customer-churn-our-standard-approach-10-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>In hw5 you looked at a dataset about <a class="reference external" href="https://en.wikipedia.org/wiki/Customer_attrition">customer churn</a>.</p></li>
<li><p>In hw5, the dataset was interesting because it’s unbalanced (most customers stay). We used typical binary classification approach on the dataset.</p></li>
<li><p>Today we’ll look at a different customer churn <a class="reference external" href="https://www.kaggle.com/blastchar/telco-customer-churn">dataset</a>, because it has a feature we need - time!</p></li>
<li><p>We’ll explore the time aspect of the dataset today.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/WA_Fn-UseC_-Telco-Customer-Churn.csv&quot;</span><span class="p">)</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">ky</span><span class="o">/</span><span class="mi">533</span><span class="n">nd9l512l5cmmk_kzmzj9m0000gp</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_97260</span><span class="o">/</span><span class="mf">3468655160.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/WA_Fn-UseC_-Telco-Customer-Churn.csv&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/util/_decorators.py</span> in <span class="ni">wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">309</span>                     <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span>                 <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">311</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span> 
<span class="g g-Whitespace">    </span><span class="mi">313</span>         <span class="k">return</span> <span class="n">wrapper</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">read_csv</span><span class="nt">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, squeeze, prefix, mangle_dupe_cols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, error_bad_lines, warn_bad_lines, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">584</span>     <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds_defaults</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">585</span> 
<span class="ne">--&gt; </span><span class="mi">586</span>     <span class="k">return</span> <span class="n">_read</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">587</span> 
<span class="g g-Whitespace">    </span><span class="mi">588</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">_read</span><span class="nt">(filepath_or_buffer, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">480</span> 
<span class="g g-Whitespace">    </span><span class="mi">481</span>     <span class="c1"># Create the parser.</span>
<span class="ne">--&gt; </span><span class="mi">482</span>     <span class="n">parser</span> <span class="o">=</span> <span class="n">TextFileReader</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">483</span> 
<span class="g g-Whitespace">    </span><span class="mi">484</span>     <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">or</span> <span class="n">iterator</span><span class="p">:</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">__init__</span><span class="nt">(self, f, engine, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">809</span>             <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">810</span> 
<span class="ne">--&gt; </span><span class="mi">811</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span> 
<span class="g g-Whitespace">    </span><span class="mi">813</span>     <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">_make_engine</span><span class="nt">(self, engine)</span>
<span class="g g-Whitespace">   </span><span class="mi">1038</span>             <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1039</span>         <span class="c1"># error: Too many arguments for &quot;ParserBase&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1040</span>         <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">engine</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
<span class="g g-Whitespace">   </span><span class="mi">1041</span> 
<span class="g g-Whitespace">   </span><span class="mi">1042</span>     <span class="k">def</span> <span class="nf">_failover_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/c_parser_wrapper.py</span> in <span class="ni">__init__</span><span class="nt">(self, src, **kwds)</span>
<span class="g g-Whitespace">     </span><span class="mi">49</span> 
<span class="g g-Whitespace">     </span><span class="mi">50</span>         <span class="c1"># open handles</span>
<span class="ne">---&gt; </span><span class="mi">51</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_open_handles</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>         <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/base_parser.py</span> in <span class="ni">_open_handles</span><span class="nt">(self, src, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">220</span>         <span class="n">Let</span> <span class="n">the</span> <span class="n">readers</span> <span class="nb">open</span> <span class="n">IOHandles</span> <span class="n">after</span> <span class="n">they</span> <span class="n">are</span> <span class="n">done</span> <span class="k">with</span> <span class="n">their</span> <span class="n">potential</span> <span class="n">raises</span><span class="o">.</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">222</span><span class="s2">         self.handles = get_handle(</span>
<span class="g g-Whitespace">    </span><span class="mi">223</span><span class="s2">             src,</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span><span class="s2">             &quot;r&quot;,</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/common.py</span> in <span class="ni">get_handle</span><span class="nt">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">699</span><span class="s2">         if ioargs.encoding and &quot;b&quot; not in ioargs.mode:</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span><span class="s2">             # Encoding</span>
<span class="ne">--&gt; </span><span class="mi">701</span><span class="s2">             handle = open(</span>
<span class="g g-Whitespace">    </span><span class="mi">702</span><span class="s2">                 handle,</span>
<span class="g g-Whitespace">    </span><span class="mi">703</span><span class="s2">                 ioargs.mode,</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;data/WA_Fn-UseC_-Telco-Customer-Churn.csv&#39;
</pre></div>
</div>
</div>
</div>
<p>We can treat this as a binary classification problem where we want to predict <code class="docutils literal notranslate"><span class="pre">Churn</span></code> (yes/no) from these other columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5282, 21)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No     3912
Yes    1370
Name: Churn, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 5282 entries, 6464 to 3582
Data columns (total 21 columns):
 #   Column            Non-Null Count  Dtype  
---  ------            --------------  -----  
 0   customerID        5282 non-null   object 
 1   gender            5282 non-null   object 
 2   SeniorCitizen     5282 non-null   int64  
 3   Partner           5282 non-null   object 
 4   Dependents        5282 non-null   object 
 5   tenure            5282 non-null   int64  
 6   PhoneService      5282 non-null   object 
 7   MultipleLines     5282 non-null   object 
 8   InternetService   5282 non-null   object 
 9   OnlineSecurity    5282 non-null   object 
 10  OnlineBackup      5282 non-null   object 
 11  DeviceProtection  5282 non-null   object 
 12  TechSupport       5282 non-null   object 
 13  StreamingTV       5282 non-null   object 
 14  StreamingMovies   5282 non-null   object 
 15  Contract          5282 non-null   object 
 16  PaperlessBilling  5282 non-null   object 
 17  PaymentMethod     5282 non-null   object 
 18  MonthlyCharges    5282 non-null   float64
 19  TotalCharges      5282 non-null   object 
 20  Churn             5282 non-null   object 
dtypes: float64(1), int64(2), object(18)
memory usage: 907.8+ KB
</pre></div>
</div>
</div>
</div>
<p>Question: Does this mean there is no missing data?</p>
<p>Ok, let’s try our usual approach:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    4430
1     852
Name: SeniorCitizen, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">,</span> <span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;customerID&quot;</span><span class="p">]</span>
<span class="n">passthrough_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span>
<span class="n">target_column</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="c1"># the rest are categorical</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">passthrough_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">drop_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">target_column</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">ky</span><span class="o">/</span><span class="mi">533</span><span class="n">nd9l512l5cmmk_kzmzj9m0000gp</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_25627</span><span class="o">/</span><span class="mf">2961559258.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">);</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/compose/_column_transformer.py</span> in <span class="ni">fit</span><span class="nt">(self, X, y)</span>
<span class="g g-Whitespace">    </span><span class="mi">468</span>         <span class="c1"># we use fit_transform to make sure to set sparse_output_ (for which we</span>
<span class="g g-Whitespace">    </span><span class="mi">469</span>         <span class="c1"># need the transformed data) to have consistent output type in predict</span>
<span class="ne">--&gt; </span><span class="mi">470</span>         <span class="bp">self</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">471</span>         <span class="k">return</span> <span class="bp">self</span>
<span class="g g-Whitespace">    </span><span class="mi">472</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/compose/_column_transformer.py</span> in <span class="ni">fit_transform</span><span class="nt">(self, X, y)</span>
<span class="g g-Whitespace">    </span><span class="mi">505</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_validate_remainder</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">506</span> 
<span class="ne">--&gt; </span><span class="mi">507</span>         <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_fit_transform_one</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">508</span> 
<span class="g g-Whitespace">    </span><span class="mi">509</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/compose/_column_transformer.py</span> in <span class="ni">_fit_transform</span><span class="nt">(self, X, y, func, fitted)</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">(</span><span class="n">fitted</span><span class="o">=</span><span class="n">fitted</span><span class="p">,</span> <span class="n">replace_strings</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">433</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">434</span>             <span class="k">return</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">)(</span>
<span class="g g-Whitespace">    </span><span class="mi">435</span>                 <span class="n">delayed</span><span class="p">(</span><span class="n">func</span><span class="p">)(</span>
<span class="g g-Whitespace">    </span><span class="mi">436</span>                     <span class="n">transformer</span><span class="o">=</span><span class="n">clone</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">fitted</span> <span class="k">else</span> <span class="n">trans</span><span class="p">,</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">__call__</span><span class="nt">(self, iterable)</span>
<span class="g g-Whitespace">   </span><span class="mi">1039</span>             <span class="c1"># remaining jobs.</span>
<span class="g g-Whitespace">   </span><span class="mi">1040</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_iterating</span> <span class="o">=</span> <span class="kc">False</span>
<span class="ne">-&gt; </span><span class="mi">1041</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_one_batch</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1042</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_iterating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_iterator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1043</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">dispatch_one_batch</span><span class="nt">(self, iterator)</span>
<span class="g g-Whitespace">    </span><span class="mi">857</span>                 <span class="k">return</span> <span class="kc">False</span>
<span class="g g-Whitespace">    </span><span class="mi">858</span>             <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">859</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">860</span>                 <span class="k">return</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">861</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">_dispatch</span><span class="nt">(self, batch)</span>
<span class="g g-Whitespace">    </span><span class="mi">775</span>         <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">776</span>             <span class="n">job_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">777</span>             <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">cb</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">778</span>             <span class="c1"># A job can complete so quickly than its callback is</span>
<span class="g g-Whitespace">    </span><span class="mi">779</span>             <span class="c1"># called before we get here, causing self._jobs to</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/_parallel_backends.py</span> in <span class="ni">apply_async</span><span class="nt">(self, func, callback)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">def</span> <span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>         <span class="sd">&quot;&quot;&quot;Schedule a func to be run&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">208</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">ImmediateResult</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>         <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>             <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/_parallel_backends.py</span> in <span class="ni">__init__</span><span class="nt">(self, batch)</span>
<span class="g g-Whitespace">    </span><span class="mi">570</span>         <span class="c1"># Don&#39;t delay the application, to avoid keeping the input</span>
<span class="g g-Whitespace">    </span><span class="mi">571</span>         <span class="c1"># arguments in memory</span>
<span class="ne">--&gt; </span><span class="mi">572</span>         <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">batch</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span> 
<span class="g g-Whitespace">    </span><span class="mi">574</span>     <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">__call__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>         <span class="c1"># change the default number of processes to -1</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span>         <span class="k">with</span> <span class="n">parallel_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">262</span>             <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span>                     <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>         <span class="c1"># change the default number of processes to -1</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span>         <span class="k">with</span> <span class="n">parallel_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">262</span>             <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span>                     <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/utils/fixes.py</span> in <span class="ni">__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">220</span>     <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span>         <span class="k">with</span> <span class="n">config_context</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">222</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/pipeline.py</span> in <span class="ni">_fit_transform_one</span><span class="nt">(transformer, X, y, weight, message_clsname, message, **fit_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">752</span>     <span class="k">with</span> <span class="n">_print_elapsed_time</span><span class="p">(</span><span class="n">message_clsname</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">753</span>         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="s1">&#39;fit_transform&#39;</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">754</span>             <span class="n">res</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">755</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">756</span>             <span class="n">res</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/base.py</span> in <span class="ni">fit_transform</span><span class="nt">(self, X, y, **fit_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">697</span>         <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">698</span>             <span class="c1"># fit method of arity 1 (unsupervised transformation)</span>
<span class="ne">--&gt; </span><span class="mi">699</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">701</span>             <span class="c1"># fit method of arity 2 (supervised transformation)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/preprocessing/_data.py</span> in <span class="ni">fit</span><span class="nt">(self, X, y, sample_weight)</span>
<span class="g g-Whitespace">    </span><span class="mi">728</span>         <span class="c1"># Reset internal state before fitting</span>
<span class="g g-Whitespace">    </span><span class="mi">729</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">730</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">731</span> 
<span class="g g-Whitespace">    </span><span class="mi">732</span>     <span class="k">def</span> <span class="nf">partial_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/preprocessing/_data.py</span> in <span class="ni">partial_fit</span><span class="nt">(self, X, y, sample_weight)</span>
<span class="g g-Whitespace">    </span><span class="mi">764</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">765</span><span class="s2">         first_call = not hasattr(self, &quot;n_samples_seen_&quot;)</span>
<span class="ne">--&gt; </span><span class="mi">766</span><span class="s2">         X = self._validate_data(X, accept_sparse=(&#39;csr&#39;, &#39;csc&#39;),</span>
<span class="g g-Whitespace">    </span><span class="mi">767</span><span class="s2">                                 estimator=self, dtype=FLOAT_DTYPES,</span>
<span class="g g-Whitespace">    </span><span class="mi">768</span><span class="s2">                                 force_all_finite=&#39;allow-nan&#39;, reset=first_call)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/base.py</span> in <span class="ni">_validate_data</span><span class="nt">(self, X, y, reset, validate_separately, **check_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">419</span><span class="s2">             out = X</span>
<span class="g g-Whitespace">    </span><span class="mi">420</span><span class="s2">         elif isinstance(y, str) and y == &#39;no_validation&#39;:</span>
<span class="ne">--&gt; </span><span class="mi">421</span><span class="s2">             X = check_array(X, **check_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">422</span><span class="s2">             out = X</span>
<span class="g g-Whitespace">    </span><span class="mi">423</span><span class="s2">         else:</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/utils/validation.py</span> in <span class="ni">inner_f</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">61</span><span class="s2">             extra_args = len(args) - len(all_args)</span>
<span class="g g-Whitespace">     </span><span class="mi">62</span><span class="s2">             if extra_args &lt;= 0:</span>
<span class="ne">---&gt; </span><span class="mi">63</span><span class="s2">                 return f(*args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span><span class="s2"> </span>
<span class="g g-Whitespace">     </span><span class="mi">65</span><span class="s2">             # extra_args &gt; 0</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/sklearn/utils/validation.py</span> in <span class="ni">check_array</span><span class="nt">(array, accept_sparse, accept_large_sparse, dtype, order, copy, force_all_finite, ensure_2d, allow_nd, ensure_min_samples, ensure_min_features, estimator)</span>
<span class="g g-Whitespace">    </span><span class="mi">671</span><span class="s2">                     array = array.astype(dtype, casting=&quot;unsafe&quot;, copy=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">672</span><span class="s2">                 else:</span>
<span class="ne">--&gt; </span><span class="mi">673</span><span class="s2">                     array = np.asarray(array, order=order, dtype=dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">674</span><span class="s2">             except ComplexWarning as complex_warning:</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span><span class="s2">                 raise ValueError(&quot;Complex data not supported</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/numpy/core/_asarray.py</span> in <span class="ni">asarray</span><span class="nt">(a, dtype, order, like)</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span><span class="s2">         return _asarray_with_like(a, dtype=dtype, order=order, like=like)</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span><span class="s2"> </span>
<span class="ne">--&gt; </span><span class="mi">102</span><span class="s2">     return array(a, dtype, copy=False, order=order)</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">104</span><span class="s2"> </span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/core/generic.py</span> in <span class="ni">__array__</span><span class="nt">(self, dtype)</span>
<span class="g g-Whitespace">   </span><span class="mi">1991</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1992</span><span class="s2">     def __array__(self, dtype: NpDtype | None = None) -&gt; np.ndarray:</span>
<span class="ne">-&gt; </span><span class="mi">1993</span><span class="s2">         return np.asarray(self._values, dtype=dtype)</span>
<span class="g g-Whitespace">   </span><span class="mi">1994</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1995</span><span class="s2">     def __array_wrap__(</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/numpy/core/_asarray.py</span> in <span class="ni">asarray</span><span class="nt">(a, dtype, order, like)</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span><span class="s2">         return _asarray_with_like(a, dtype=dtype, order=order, like=like)</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span><span class="s2"> </span>
<span class="ne">--&gt; </span><span class="mi">102</span><span class="s2">     return array(a, dtype, copy=False, order=order)</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">104</span><span class="s2"> </span>

<span class="ne">ValueError</span>: could not convert string to float: &#39;&#39;
</pre></div>
</div>
</div>
</div>
<p>Hmmm, one of the numeric features is causing problems?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 7043 entries, 0 to 7042
Data columns (total 21 columns):
 #   Column            Non-Null Count  Dtype  
---  ------            --------------  -----  
 0   customerID        7043 non-null   object 
 1   gender            7043 non-null   object 
 2   SeniorCitizen     7043 non-null   int64  
 3   Partner           7043 non-null   object 
 4   Dependents        7043 non-null   object 
 5   tenure            7043 non-null   int64  
 6   PhoneService      7043 non-null   object 
 7   MultipleLines     7043 non-null   object 
 8   InternetService   7043 non-null   object 
 9   OnlineSecurity    7043 non-null   object 
 10  OnlineBackup      7043 non-null   object 
 11  DeviceProtection  7043 non-null   object 
 12  TechSupport       7043 non-null   object 
 13  StreamingTV       7043 non-null   object 
 14  StreamingMovies   7043 non-null   object 
 15  Contract          7043 non-null   object 
 16  PaperlessBilling  7043 non-null   object 
 17  PaymentMethod     7043 non-null   object 
 18  MonthlyCharges    7043 non-null   float64
 19  TotalCharges      7043 non-null   object 
 20  Churn             7043 non-null   object 
dtypes: float64(1), int64(2), object(18)
memory usage: 1.1+ MB
</pre></div>
</div>
</div>
</div>
<p>Oh, looks like <code class="docutils literal notranslate"><span class="pre">TotalCharges</span></code> is not a numeric type. What if we change the type of this column to float?</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">ky</span><span class="o">/</span><span class="mi">533</span><span class="n">nd9l512l5cmmk_kzmzj9m0000gp</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_25627</span><span class="o">/</span><span class="mf">2516325513.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/core/generic.py</span> in <span class="ni">astype</span><span class="nt">(self, dtype, copy, errors)</span>
<span class="g g-Whitespace">   </span><span class="mi">5813</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">5814</span>             <span class="c1"># else, only a single dtype is given</span>
<span class="ne">-&gt; </span><span class="mi">5815</span>             <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mgr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">5816</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span><span class="o">.</span><span class="n">__finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;astype&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">5817</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/core/internals/managers.py</span> in <span class="ni">astype</span><span class="nt">(self, dtype, copy, errors)</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span> 
<span class="g g-Whitespace">    </span><span class="mi">417</span>     <span class="k">def</span> <span class="nf">astype</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">errors</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;raise&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">418</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s2">&quot;astype&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">419</span> 
<span class="g g-Whitespace">    </span><span class="mi">420</span>     <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/core/internals/managers.py</span> in <span class="ni">apply</span><span class="nt">(self, f, align_keys, ignore_failures, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span>                     <span class="n">applied</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>                 <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">327</span>                     <span class="n">applied</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">328</span>             <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span>                 <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_failures</span><span class="p">:</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/core/internals/blocks.py</span> in <span class="ni">astype</span><span class="nt">(self, dtype, copy, errors)</span>
<span class="g g-Whitespace">    </span><span class="mi">590</span>         <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
<span class="g g-Whitespace">    </span><span class="mi">591</span> 
<span class="ne">--&gt; </span><span class="mi">592</span>         <span class="n">new_values</span> <span class="o">=</span> <span class="n">astype_array_safe</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span> 
<span class="g g-Whitespace">    </span><span class="mi">594</span>         <span class="n">new_values</span> <span class="o">=</span> <span class="n">maybe_coerce_values</span><span class="p">(</span><span class="n">new_values</span><span class="p">)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/core/dtypes/cast.py</span> in <span class="ni">astype_array_safe</span><span class="nt">(values, dtype, copy, errors)</span>
<span class="g g-Whitespace">   </span><span class="mi">1307</span> 
<span class="g g-Whitespace">   </span><span class="mi">1308</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1309</span>         <span class="n">new_values</span> <span class="o">=</span> <span class="n">astype_array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1310</span>     <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1311</span>         <span class="c1"># e.g. astype_nansafe can fail on object-dtype of strings</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/core/dtypes/cast.py</span> in <span class="ni">astype_array</span><span class="nt">(values, dtype, copy)</span>
<span class="g g-Whitespace">   </span><span class="mi">1255</span> 
<span class="g g-Whitespace">   </span><span class="mi">1256</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1257</span>         <span class="n">values</span> <span class="o">=</span> <span class="n">astype_nansafe</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1258</span> 
<span class="g g-Whitespace">   </span><span class="mi">1259</span>     <span class="c1"># in pandas we don&#39;t store numpy str dtypes, so convert to object</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/core/dtypes/cast.py</span> in <span class="ni">astype_nansafe</span><span class="nt">(arr, dtype, copy, skipna)</span>
<span class="g g-Whitespace">   </span><span class="mi">1199</span>     <span class="k">if</span> <span class="n">copy</span> <span class="ow">or</span> <span class="n">is_object_dtype</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_object_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1200</span>         <span class="c1"># Explicit copy, or required since NumPy can&#39;t view from / to object.</span>
<span class="ne">-&gt; </span><span class="mi">1201</span>         <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1202</span> 
<span class="g g-Whitespace">   </span><span class="mi">1203</span>     <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>

<span class="ne">ValueError</span>: could not convert string to float: &#39;&#39;
</pre></div>
</div>
</div>
</div>
<p>Argh!!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 
 
 
 
 
 
 
 
</pre></div>
</div>
</div>
</div>
<p>Any ideas?</p>
<p>Well, it turns out we can’t see those problematic values because they are whitespace!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
</pre></div>
</div>
</div>
</div>
<p>Let’s replace the whitespaces with NaNs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">TotalCharges</span><span class="o">=</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">TotalCharges</span><span class="o">=</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 5282 entries, 6464 to 3582
Data columns (total 21 columns):
 #   Column            Non-Null Count  Dtype  
---  ------            --------------  -----  
 0   customerID        5282 non-null   object 
 1   gender            5282 non-null   object 
 2   SeniorCitizen     5282 non-null   int64  
 3   Partner           5282 non-null   object 
 4   Dependents        5282 non-null   object 
 5   tenure            5282 non-null   int64  
 6   PhoneService      5282 non-null   object 
 7   MultipleLines     5282 non-null   object 
 8   InternetService   5282 non-null   object 
 9   OnlineSecurity    5282 non-null   object 
 10  OnlineBackup      5282 non-null   object 
 11  DeviceProtection  5282 non-null   object 
 12  TechSupport       5282 non-null   object 
 13  StreamingTV       5282 non-null   object 
 14  StreamingMovies   5282 non-null   object 
 15  Contract          5282 non-null   object 
 16  PaperlessBilling  5282 non-null   object 
 17  PaymentMethod     5282 non-null   object 
 18  MonthlyCharges    5282 non-null   float64
 19  TotalCharges      5274 non-null   float64
 20  Churn             5282 non-null   object 
dtypes: float64(2), int64(2), object(17)
memory usage: 907.8+ KB
</pre></div>
</div>
</div>
</div>
<p>But now we are going to have missing values and we need to include imputation for numeric features in our preprocessor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()),</span>
        <span class="n">numeric_features</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s try that again…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>It worked! Let’s get the column names of the transformed data from the column transformer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">numeric_features</span>
    <span class="o">+</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
    <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">passthrough_features</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
<span class="p">)</span>
<span class="n">X_test_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>MonthlyCharges</th>
      <th>TotalCharges</th>
      <th>StreamingMovies_No</th>
      <th>StreamingMovies_No internet service</th>
      <th>StreamingMovies_Yes</th>
      <th>Partner_No</th>
      <th>Partner_Yes</th>
      <th>OnlineSecurity_No</th>
      <th>OnlineSecurity_No internet service</th>
      <th>...</th>
      <th>PhoneService_Yes</th>
      <th>OnlineBackup_No</th>
      <th>OnlineBackup_No internet service</th>
      <th>OnlineBackup_Yes</th>
      <th>PaperlessBilling_No</th>
      <th>PaperlessBilling_Yes</th>
      <th>DeviceProtection_No</th>
      <th>DeviceProtection_No internet service</th>
      <th>DeviceProtection_Yes</th>
      <th>SeniorCitizen</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>0.707712</td>
      <td>0.185175</td>
      <td>0.513678</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>-1.248999</td>
      <td>-0.641538</td>
      <td>-0.979562</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>-0.148349</td>
      <td>1.133562</td>
      <td>0.226789</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>-1.248999</td>
      <td>0.458524</td>
      <td>-0.950696</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>0.993065</td>
      <td>-0.183179</td>
      <td>0.433814</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 45 columns</p>
</div></div></div>
</div>
<p>Before we look into survival analysis, let’s just treat it as a binary classification model where we want to predict whether a customer churned or not.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mean_std_cross_val_scores</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns mean and std of cross validation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model :</span>
<span class="sd">        scikit-learn model</span>
<span class="sd">    X_train : numpy array or pandas DataFrame</span>
<span class="sd">        X in the training data</span>
<span class="sd">    y_train :</span>
<span class="sd">        y in the training data</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">        pandas Series with mean scores from cross_validation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">mean_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">out_col</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mean_scores</span><span class="p">)):</span>
        <span class="n">out_col</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;%0.3f (+/- %0.3f)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mean_scores</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">std_scores</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">out_col</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">mean_scores</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">])</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">])</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dummyclassifier">
<h3>DummyClassifier<a class="headerlink" href="#dummyclassifier" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;dummy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_std_cross_val_scores</span><span class="p">(</span>
    <span class="n">dc</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dummy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>fit_time</th>
      <td>0.005 (+/- 0.001)</td>
    </tr>
    <tr>
      <th>score_time</th>
      <td>0.003 (+/- 0.001)</td>
    </tr>
    <tr>
      <th>test_score</th>
      <td>0.741 (+/- 0.000)</td>
    </tr>
    <tr>
      <th>train_score</th>
      <td>0.741 (+/- 0.000)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="logisticregression">
<h3>LogisticRegression<a class="headerlink" href="#logisticregression" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;logistic regression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_std_cross_val_scores</span><span class="p">(</span>
    <span class="n">lr</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dummy</th>
      <th>logistic regression</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>fit_time</th>
      <td>0.005 (+/- 0.001)</td>
      <td>0.129 (+/- 0.045)</td>
    </tr>
    <tr>
      <th>score_time</th>
      <td>0.003 (+/- 0.001)</td>
      <td>0.016 (+/- 0.002)</td>
    </tr>
    <tr>
      <th>test_score</th>
      <td>0.741 (+/- 0.000)</td>
      <td>0.804 (+/- 0.013)</td>
    </tr>
    <tr>
      <th>train_score</th>
      <td>0.741 (+/- 0.000)</td>
      <td>0.809 (+/- 0.002)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[3516,  396],
       [ 637,  733]])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="randomforestclassifier">
<h3>RandomForestClassifier<a class="headerlink" href="#randomforestclassifier" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;random forest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_std_cross_val_scores</span><span class="p">(</span>
    <span class="n">rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dummy</th>
      <th>logistic regression</th>
      <th>random forest</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>fit_time</th>
      <td>0.005 (+/- 0.001)</td>
      <td>0.129 (+/- 0.045)</td>
      <td>0.608 (+/- 0.102)</td>
    </tr>
    <tr>
      <th>score_time</th>
      <td>0.003 (+/- 0.001)</td>
      <td>0.016 (+/- 0.002)</td>
      <td>0.049 (+/- 0.009)</td>
    </tr>
    <tr>
      <th>test_score</th>
      <td>0.741 (+/- 0.000)</td>
      <td>0.804 (+/- 0.013)</td>
      <td>0.790 (+/- 0.013)</td>
    </tr>
    <tr>
      <th>train_score</th>
      <td>0.741 (+/- 0.000)</td>
      <td>0.809 (+/- 0.002)</td>
      <td>0.998 (+/- 0.000)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[3529,  383],
       [ 719,  651]])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>This is was we did in hw5.</p></li>
<li><p>What’s wrong with this approach?</p></li>
</ul>
<p>And now the rest of the class is about what is wrong with what we just did!</p>
<p><br><br></p>
</div>
</div>
<div class="section" id="censoring-and-survival-analysis-15-min">
<h2>Censoring and survival analysis (15 min)<a class="headerlink" href="#censoring-and-survival-analysis-15-min" title="Permalink to this headline">¶</a></h2>
<div class="section" id="time-to-event-and-censoring">
<h3>Time to event and censoring<a class="headerlink" href="#time-to-event-and-censoring" title="Permalink to this headline">¶</a></h3>
<p>Imagine that you want to analyze <em>the time until an event occurs</em>. For example,</p>
<ul class="simple">
<li><p>the time until a disease kills its host.</p></li>
<li><p>the time until a piece of equipment breaks.</p></li>
<li><p>the time that someone unemployed will take to land a new job.</p></li>
<li><p>the time until a customer leaves a subscription service (this dataset).</p></li>
</ul>
<p>In our example, instead of predicting the binary label churn or no churn, it will be more useful to when the customer is likely to churn (the time until churn happens) so that we can take some action.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The tenure column is the number of months the customer has stayed with the company.</p>
<p>Although this branch of statistics is usually referred to as <strong>Survival Analysis</strong>, the event in question does not need to be related to actual “survival”. The important thing is to understand that we are interested in <strong>the time until something happens</strong>, or whether or not something will happen in a certain time frame.</p>
<p><strong>Question:</strong> But why is this different? Can’t you just use the techniques you learned so far (e.g., regression models) to predict the time? Take a minute to think about this.</p>
<p>The answer would be yes if you could observe the actual time in all occurrences, but you usually cannot. Frequently, there will be some kind of <strong>censoring</strong> which will not allow you to observe the exact time that the event happened for all units/individuals that are being studied.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>What this means is that we <strong>don’t have correct target values</strong> to train or test our model.</p></li>
<li><p>This is a problem!</p></li>
</ul>
<p>Let’s consider some approaches to deal with this censoring issue.</p>
</div>
<div class="section" id="approach-1-only-consider-the-examples-where-churn-yes">
<h3>Approach 1: Only consider the examples where “Churn”=Yes<a class="headerlink" href="#approach-1-only-consider-the-examples-where-churn-yes" title="Permalink to this headline">¶</a></h3>
<p>Let’s just consider the cases <em>for which we have the time</em>, to obtain the average subscription length.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_churn</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;Churn == &#39;Yes&#39;&quot;</span>
<span class="p">)</span>  <span class="c1"># Consider only examples where the customers churned.</span>
<span class="n">test_df_churn</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;Churn == &#39;Yes&#39;&quot;</span>
<span class="p">)</span>  <span class="c1"># Consider only examples where the customers churned.</span>
<span class="n">train_df_churn</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customerID</th>
      <th>gender</th>
      <th>SeniorCitizen</th>
      <th>Partner</th>
      <th>Dependents</th>
      <th>tenure</th>
      <th>PhoneService</th>
      <th>MultipleLines</th>
      <th>InternetService</th>
      <th>OnlineSecurity</th>
      <th>...</th>
      <th>DeviceProtection</th>
      <th>TechSupport</th>
      <th>StreamingTV</th>
      <th>StreamingMovies</th>
      <th>Contract</th>
      <th>PaperlessBilling</th>
      <th>PaymentMethod</th>
      <th>MonthlyCharges</th>
      <th>TotalCharges</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3932</th>
      <td>1304-NECVQ</td>
      <td>Female</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>2</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>78.55</td>
      <td>149.55</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>301</th>
      <td>8098-LLAZX</td>
      <td>Female</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>4</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>95.45</td>
      <td>396.10</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>5540</th>
      <td>3803-KMQFW</td>
      <td>Female</td>
      <td>0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>1</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No internet service</td>
      <td>...</td>
      <td>No internet service</td>
      <td>No internet service</td>
      <td>No internet service</td>
      <td>No internet service</td>
      <td>Month-to-month</td>
      <td>No</td>
      <td>Mailed check</td>
      <td>20.55</td>
      <td>20.55</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>4084</th>
      <td>2777-PHDEI</td>
      <td>Female</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>1</td>
      <td>Yes</td>
      <td>No</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>No</td>
      <td>Electronic check</td>
      <td>78.05</td>
      <td>78.05</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>3272</th>
      <td>6772-KSATR</td>
      <td>Male</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>1</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>Yes</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>81.70</td>
      <td>81.70</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5282, 21)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_churn</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1370, 21)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;tenure&#39;, &#39;MonthlyCharges&#39;, &#39;TotalCharges&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing_notenure</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()),</span>
        <span class="n">numeric_features</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>  <span class="c1"># Getting rid of the tenure column</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tenure_lm</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessing_notenure</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">())</span>

<span class="n">tenure_lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df_churn</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]),</span> <span class="n">train_df_churn</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">tenure_lm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df_churn</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]))[:</span><span class="mi">10</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure_predictions&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure_predictions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.062449</td>
    </tr>
    <tr>
      <th>1</th>
      <td>13.198645</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11.859455</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5.865562</td>
    </tr>
    <tr>
      <th>4</th>
      <td>58.154842</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3.757932</td>
    </tr>
    <tr>
      <th>6</th>
      <td>18.932070</td>
    </tr>
    <tr>
      <th>7</th>
      <td>7.720893</td>
    </tr>
    <tr>
      <th>8</th>
      <td>36.818041</td>
    </tr>
    <tr>
      <th>9</th>
      <td>7.263541</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>What will be wrong with our estimated survival times? Will they be too low or too high?
<br><br><br><br><br><br><br></p>
<p>On average they will be <strong>underestimates</strong> (too small), because we are ignoring the currently subscribed (un-churned) customers. Our dataset is a biased sample of those who churned within the time window of the data collection. Long-time subscribers were more likely to be removed from the dataset! This is a common mistake - see the <a class="reference external" href="https://www.youtube.com/watch?v=ITWQ5psx9Sw">Calling Bullshit video</a> I posted on the README!</p>
<p><br><br></p>
</div>
<div class="section" id="approach-2-assume-everyone-churns-right-now">
<h3>Approach 2: Assume everyone churns right now<a class="headerlink" href="#approach-2-assume-everyone-churns-right-now" title="Permalink to this headline">¶</a></h3>
<p>Assume everyone churns right now - in other words, use the original dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tenure_lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]),</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">tenure_lm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df_churn</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]))[:</span><span class="mi">10</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure_predictions&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure_predictions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6.400047</td>
    </tr>
    <tr>
      <th>1</th>
      <td>20.220392</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22.332746</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12.825470</td>
    </tr>
    <tr>
      <th>4</th>
      <td>59.885968</td>
    </tr>
    <tr>
      <th>5</th>
      <td>7.075453</td>
    </tr>
    <tr>
      <th>6</th>
      <td>17.731498</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10.407862</td>
    </tr>
    <tr>
      <th>8</th>
      <td>38.425365</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10.854500</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>What will be wrong with our estimated survival time?
<br><br><br><br><br><br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>It will be an <strong>underestimate</strong> again. For those still subscribed, while we did not remove them, we recorded a total tenure shorter than in reality, because they will keep going for some amount of time.</p>
<p><br><br></p>
</div>
<div class="section" id="approach-3-survival-analysis">
<h3>Approach 3: Survival analysis<a class="headerlink" href="#approach-3-survival-analysis" title="Permalink to this headline">¶</a></h3>
<p>Deal with this properly using <a class="reference external" href="https://en.wikipedia.org/wiki/Survival_analysis">survival analysis</a>.</p>
<ul class="simple">
<li><p>You may learn about this in a statistics course.</p></li>
<li><p>We will use the <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> package in Python and will not go into the math/stats of how it works.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="section" id="types-of-questions-we-might-want-to-answer">
<h4>Types of questions we might want to answer:<a class="headerlink" href="#types-of-questions-we-might-want-to-answer" title="Permalink to this headline">¶</a></h4>
<ol class="simple">
<li><p>How long do customers stay with the service?</p></li>
<li><p>For a particular customer, can we predict how long they might stay with the service?</p></li>
<li><p>What factors influence a customer’s churn time?</p></li>
</ol>
</div>
</div>
</div>
<div class="section" id="break-5-min">
<h2>Break (5 min)<a class="headerlink" href="#break-5-min" title="Permalink to this headline">¶</a></h2>
<p><img alt="" src="../_images/eva-coffee.png" /></p>
</div>
<div class="section" id="kaplan-meier-survival-curve-10-min">
<h2>Kaplan-Meier survival curve (10 min)<a class="headerlink" href="#kaplan-meier-survival-curve-10-min" title="Permalink to this headline">¶</a></h2>
<p>Before we do anything further, I want to modify our dataset slightly:</p>
<ol class="simple">
<li><p>I’m going to drop the <code class="docutils literal notranslate"><span class="pre">TotalCharges</span></code> (yes, after all that work fixing it) because it’s a bit of a strange feature.</p></li>
</ol>
<ul class="simple">
<li><p>Its value actually changes over time, but we only have the value at the end.</p></li>
<li><p>We still have <code class="docutils literal notranslate"><span class="pre">MonthlyCharges</span></code>.</p></li>
</ul>
<ol class="simple">
<li><p>I’m going to not scale the <code class="docutils literal notranslate"><span class="pre">tenure</span></code> column, since it will be convenient to keep it in its original units of months.</p></li>
</ol>
<p>Just for our sanity, I’m redefining the features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">]</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;customerID&quot;</span><span class="p">,</span> <span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span>
<span class="n">passthrough_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span>  <span class="c1"># don&#39;t want to scale tenure</span>
<span class="n">target_column</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="c1"># the rest are categorical</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">passthrough_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">drop_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">target_column</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing_final</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">FunctionTransformer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">),</span>
        <span class="n">target_column</span><span class="p">,</span>
    <span class="p">),</span>  <span class="c1"># because we need it in this format for lifelines package</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing_final</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s get the column names of the columns created by our column transformer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">target_column</span>
    <span class="o">+</span> <span class="n">passthrough_features</span>
    <span class="o">+</span> <span class="n">numeric_features</span>
    <span class="o">+</span> <span class="n">preprocessing_final</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
    <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_surv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">preprocessing_final</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
<span class="p">)</span>
<span class="n">test_df_surv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">preprocessing_final</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_surv</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Churn</th>
      <th>tenure</th>
      <th>SeniorCitizen</th>
      <th>MonthlyCharges</th>
      <th>StreamingMovies_No</th>
      <th>StreamingMovies_No internet service</th>
      <th>StreamingMovies_Yes</th>
      <th>Partner_No</th>
      <th>Partner_Yes</th>
      <th>OnlineSecurity_No</th>
      <th>...</th>
      <th>PhoneService_No</th>
      <th>PhoneService_Yes</th>
      <th>OnlineBackup_No</th>
      <th>OnlineBackup_No internet service</th>
      <th>OnlineBackup_Yes</th>
      <th>PaperlessBilling_No</th>
      <th>PaperlessBilling_Yes</th>
      <th>DeviceProtection_No</th>
      <th>DeviceProtection_No internet service</th>
      <th>DeviceProtection_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>0.0</td>
      <td>50.0</td>
      <td>1.0</td>
      <td>0.185175</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>-0.641538</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>0.0</td>
      <td>29.0</td>
      <td>0.0</td>
      <td>1.133562</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>1.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.458524</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>0.0</td>
      <td>57.0</td>
      <td>0.0</td>
      <td>-0.183179</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 45 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>We’ll start with a model called <code class="docutils literal notranslate"><span class="pre">KaplanMeierFitter</span></code> from <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> package to get a Kaplan Meier curve.</p></li>
<li><p>For this model we only use two columns: tenure and churn.</p></li>
<li><p>We do not use any other features.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">KaplanMeierFitter</span><span class="p">()</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">],</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span><span class="o">.</span><span class="n">survival_function_</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Survival function of customer churn&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_105_0.png" src="../_images/19_survival-analysis_105_0.png" />
</div>
</div>
<ul class="simple">
<li><p>What is this plot telling us?</p></li>
<li><p>It shows the probability of survival over time.</p></li>
<li><p>For example, after 20 months the probability of survival is ~0.8.</p></li>
<li><p>Over time it’s going down.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7406285497917455
</pre></div>
</div>
</div>
</div>
<p>What’s the average tenure?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>32.6391518364256
</pre></div>
</div>
</div>
</div>
<p>What’s the average tenure of the people who churned?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_df_surv</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Churn == 1.0&quot;</span><span class="p">)[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>17.854744525547446
</pre></div>
</div>
</div>
</div>
<p>What’s the average tenure of the people who did not churn?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_df_surv</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Churn == 0.0&quot;</span><span class="p">)[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>37.816717791411044
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Let’s look at the histogram of number of people who have not churned.</p></li>
<li><p>The key point here is that people <em>joined at different times</em>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span><span class="p">][</span><span class="s2">&quot;tenure&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;months&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_115_0.png" src="../_images/19_survival-analysis_115_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Since the data was collected at a fixed time and these are the people who hadn’t yet churned, those with larger <code class="docutils literal notranslate"><span class="pre">tenure</span></code> values here must have joined earlier.</p></li>
</ul>
<p>Lifelines can also give us some “error bars”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Survival function of customer churn&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_118_0.png" src="../_images/19_survival-analysis_118_0.png" />
</div>
</div>
<ul class="simple">
<li><p>We already have some actionable information here.</p></li>
<li><p>The curve drops down fast at the beginning suggesting that people tend to leave early on.</p></li>
<li><p>If there would have been a big drop in the curve, it means a bunch of people left at that time (e.g., after a 1-month free trial).</p></li>
<li><p>BTW, the <a class="reference external" href="https://web.stanford.edu/~lutian/coursepdf/KMpaper.pdf">original paper by Kaplan and Meier</a> has been cited over 57000 times!</p></li>
</ul>
<p>We can also create the K-M curve for different subgroups:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="n">senior</span> <span class="o">=</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">senior</span><span class="p">],</span> <span class="n">event_observed</span><span class="o">=</span><span class="n">E</span><span class="p">[</span><span class="n">senior</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Senior Citizens&quot;</span><span class="p">)</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">~</span><span class="n">senior</span><span class="p">],</span> <span class="n">event_observed</span><span class="o">=</span><span class="n">E</span><span class="p">[</span><span class="o">~</span><span class="n">senior</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Non-Senior Citizens&quot;</span><span class="p">)</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_122_0.png" src="../_images/19_survival-analysis_122_0.png" />
</div>
</div>
<ul class="simple">
<li><p>It looks like senior citizens churn more quickly than others.</p></li>
<li><p>This is quite useful!</p></li>
</ul>
<p><br><br></p>
</div>
<div class="section" id="cox-proportional-hazards-model-10-min">
<h2>Cox proportional hazards model (10 min)<a class="headerlink" href="#cox-proportional-hazards-model-10-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>We haven’t been incorporating other features in the model so far.</p></li>
<li><p>The Cox proportional hazards model is a commonly used model that allows us to interpret how features influence a censored tenure/duration.</p></li>
<li><p>You can think of it like linear regression for survival analysis: we will get a coefficient for each feature that tells us how it influences survival.</p></li>
<li><p>It makes some strong assumptions (the proportional hazards assumption) that may not be true, but we won’t go into this here.</p></li>
<li><p>The proportional hazard model works multiplicatively, like linear regression with log-transformed targets.</p></li>
</ul>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">CoxPHFitter</span><span class="p">()</span>
<span class="n">cph</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="n">event_col</span><span class="o">=</span><span class="s2">&quot;Churn&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">LinAlgError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_newton_rhapson_for_efron_model</span><span class="nt">(self, X, T, E, weights, entries, initial_point, step_size, precision, show_progress, max_steps)</span>
<span class="g g-Whitespace">   </span><span class="mi">1517</span>             <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1518</span>                 <span class="n">inv_h_dot_g_T</span> <span class="o">=</span> <span class="n">spsolve</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">assume_a</span><span class="o">=</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1519</span>             <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">LinAlgError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/scipy/linalg/basic.py</span> in <span class="ni">solve</span><span class="nt">(a, b, sym_pos, lower, overwrite_a, overwrite_b, debug, check_finite, assume_a, transposed)</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>                            <span class="n">overwrite_b</span><span class="o">=</span><span class="n">overwrite_b</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">253</span>         <span class="n">_solve_check</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">254</span>         <span class="n">rcond</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pocon</span><span class="p">(</span><span class="n">lu</span><span class="p">,</span> <span class="n">anorm</span><span class="p">)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/scipy/linalg/basic.py</span> in <span class="ni">_solve_check</span><span class="nt">(n, info, lamch, rcond)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span>     <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">29</span>         <span class="k">raise</span> <span class="n">LinAlgError</span><span class="p">(</span><span class="s1">&#39;Matrix is singular.&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span> 

<span class="ne">LinAlgError</span>: Matrix is singular.

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">ConvergenceError</span><span class="g g-Whitespace">                          </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">ky</span><span class="o">/</span><span class="mi">533</span><span class="n">nd9l512l5cmmk_kzmzj9m0000gp</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_25627</span><span class="o">/</span><span class="mf">2468730739.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">cph</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">CoxPHFitter</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">cph</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="n">event_col</span><span class="o">=</span><span class="s2">&quot;Churn&quot;</span><span class="p">);</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/lifelines/utils/__init__.py</span> in <span class="ni">f</span><span class="nt">(model, *args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>         <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>             <span class="bp">cls</span><span class="o">.</span><span class="n">set_censoring_type</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">54</span>             <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span> 
<span class="g g-Whitespace">     </span><span class="mi">56</span>         <span class="k">return</span> <span class="n">f</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">fit</span><span class="nt">(self, df, duration_col, event_col, show_progress, initial_point, strata, step_size, weights_col, cluster_col, robust, batch_mode, timeline, formula, entry_col)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd">         self.strata = utils.coalesce(strata, self.strata)</span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">         self._model = self._fit_model(</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">             df,</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd">             duration_col,</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_fit_model</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">608</span><span class="sd">     def _fit_model(self, *args, **kwargs):</span>
<span class="g g-Whitespace">    </span><span class="mi">609</span><span class="sd">         if self.baseline_estimation_method == &quot;breslow&quot;:</span>
<span class="ne">--&gt; </span><span class="mi">610</span><span class="sd">             return self._fit_model_breslow(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">611</span><span class="sd">         elif self.baseline_estimation_method == &quot;spline&quot;:</span>
<span class="g g-Whitespace">    </span><span class="mi">612</span><span class="sd">             return self._fit_model_spline(*args, **kwargs)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_fit_model_breslow</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">621</span><span class="sd">         )</span>
<span class="g g-Whitespace">    </span><span class="mi">622</span><span class="sd">         if utils.CensoringType.is_right_censoring(self):</span>
<span class="ne">--&gt; </span><span class="mi">623</span><span class="sd">             model.fit(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">624</span><span class="sd">             return model</span>
<span class="g g-Whitespace">    </span><span class="mi">625</span><span class="sd">         else:</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/lifelines/utils/__init__.py</span> in <span class="ni">f</span><span class="nt">(model, *args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span><span class="sd">         def f(model, *args, **kwargs):</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span><span class="sd">             cls.set_censoring_type(model, cls.RIGHT)</span>
<span class="ne">---&gt; </span><span class="mi">54</span><span class="sd">             return function(model, *args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">56</span><span class="sd">         return f</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">fit</span><span class="nt">(self, df, duration_col, event_col, show_progress, initial_point, strata, step_size, weights_col, cluster_col, robust, batch_mode, timeline, formula, entry_col)</span>
<span class="g g-Whitespace">   </span><span class="mi">1249</span><span class="sd">         )</span>
<span class="g g-Whitespace">   </span><span class="mi">1250</span><span class="sd"> </span>
<span class="ne">-&gt; </span><span class="mi">1251</span><span class="sd">         params_, ll_, variance_matrix_, baseline_hazard_, baseline_cumulative_hazard_, model = self._fit_model(</span>
<span class="g g-Whitespace">   </span><span class="mi">1252</span><span class="sd">             X_norm,</span>
<span class="g g-Whitespace">   </span><span class="mi">1253</span><span class="sd">             T,</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_fit_model</span><span class="nt">(self, X, T, E, weights, entries, initial_point, step_size, show_progress)</span>
<span class="g g-Whitespace">   </span><span class="mi">1377</span><span class="sd">         show_progress: bool = True,</span>
<span class="g g-Whitespace">   </span><span class="mi">1378</span><span class="sd">     ):</span>
<span class="ne">-&gt; </span><span class="mi">1379</span><span class="sd">         beta_, ll_, hessian_ = self._newton_rhapson_for_efron_model(</span>
<span class="g g-Whitespace">   </span><span class="mi">1380</span><span class="sd">             X, T, E, weights, entries, initial_point=initial_point, step_size=step_size, show_progress=show_progress</span>
<span class="g g-Whitespace">   </span><span class="mi">1381</span><span class="sd">         )</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_newton_rhapson_for_efron_model</span><span class="nt">(self, X, T, E, weights, entries, initial_point, step_size, precision, show_progress, max_steps)</span>
<span class="g g-Whitespace">   </span><span class="mi">1525</span><span class="sd">                     )</span>
<span class="g g-Whitespace">   </span><span class="mi">1526</span><span class="sd">                 elif isinstance(e, LinAlgError):</span>
<span class="ne">-&gt; </span><span class="mi">1527</span><span class="sd">                     raise exceptions.ConvergenceError(</span>
<span class="g g-Whitespace">   </span><span class="mi">1528</span><span class="sd">                         &quot;&quot;&quot;</span><span class="n">Convergence</span> <span class="n">halted</span> <span class="n">due</span> <span class="n">to</span> <span class="n">matrix</span> <span class="n">inversion</span> <span class="n">problems</span><span class="o">.</span> <span class="n">Suspicion</span> <span class="ow">is</span> <span class="n">high</span> <span class="n">collinearity</span><span class="o">.</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="s2">&quot;&quot;&quot;.format(</span>
<span class="g g-Whitespace">   </span><span class="mi">1529</span><span class="s2">                             CONVERGENCE_DOCS</span>

<span class="ne">ConvergenceError</span>: Convergence halted due to matrix inversion problems. Suspicion is high collinearity. Please see the following tips in the lifelines documentation: https://lifelines.readthedocs.io/en/latest/Examples.html#problems-with-convergence-in-the-cox-proportional-hazard-modelMatrix is singular.
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Ok, going that <a class="reference external" href="https://lifelines.readthedocs.io/en/latest/Examples.html#problems-with-convergence-in-the-cox-proportional-hazard-model">that URL</a>, it seems the easiest solution is to add a penalizer.</p>
<ul>
<li><p>FYI this is related to switching from <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> to <code class="docutils literal notranslate"><span class="pre">Ridge</span></code>.</p></li>
<li><p>Adding <code class="docutils literal notranslate"><span class="pre">drop='first'</span></code> on our OHE might have helped with this.</p></li>
<li><p>(For 340 folks: we’re adding regularization; <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> adds both L1 and L2 regularization, aka elastic net)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">CoxPHFitter</span><span class="p">(</span><span class="n">penalizer</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cph</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="n">event_col</span><span class="o">=</span><span class="s2">&quot;Churn&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>We can look at the coefficients learned by the model and start interpreting them!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cph</span><span class="o">.</span><span class="n">params_</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cph_params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
    </tr>
    <tr>
      <th>covariate</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Contract_Month-to-month</th>
      <td>0.812874</td>
    </tr>
    <tr>
      <th>OnlineSecurity_No</th>
      <td>0.311151</td>
    </tr>
    <tr>
      <th>OnlineBackup_No</th>
      <td>0.298561</td>
    </tr>
    <tr>
      <th>PaymentMethod_Electronic check</th>
      <td>0.280801</td>
    </tr>
    <tr>
      <th>Partner_No</th>
      <td>0.244814</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>OnlineBackup_Yes</th>
      <td>-0.282600</td>
    </tr>
    <tr>
      <th>PaymentMethod_Credit card (automatic)</th>
      <td>-0.302801</td>
    </tr>
    <tr>
      <th>OnlineSecurity_Yes</th>
      <td>-0.330346</td>
    </tr>
    <tr>
      <th>Contract_One year</th>
      <td>-0.351822</td>
    </tr>
    <tr>
      <th>Contract_Two year</th>
      <td>-0.776425</td>
    </tr>
  </tbody>
</table>
<p>43 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Looks like month-to-month leads to more churn, two-year contract leads to less churn; this makes sense!!!</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cph.baseline_hazard_ # baseline hazard</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cph.summary</span>
</pre></div>
</div>
</div>
</div>
<p>Could we have gotten this type of information out of sklearn?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6464     No
5707     No
3442     No
3932    Yes
6124     No
Name: Churn, dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customerID</th>
      <th>gender</th>
      <th>SeniorCitizen</th>
      <th>Partner</th>
      <th>Dependents</th>
      <th>PhoneService</th>
      <th>MultipleLines</th>
      <th>InternetService</th>
      <th>OnlineSecurity</th>
      <th>OnlineBackup</th>
      <th>DeviceProtection</th>
      <th>TechSupport</th>
      <th>StreamingTV</th>
      <th>StreamingMovies</th>
      <th>Contract</th>
      <th>PaperlessBilling</th>
      <th>PaymentMethod</th>
      <th>MonthlyCharges</th>
      <th>TotalCharges</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>4726-DLWQN</td>
      <td>Male</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>DSL</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Bank transfer (automatic)</td>
      <td>70.35</td>
      <td>3454.60</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>4537-DKTAL</td>
      <td>Female</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>DSL</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>No</td>
      <td>Electronic check</td>
      <td>45.55</td>
      <td>84.40</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>0468-YRPXN</td>
      <td>Male</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Credit card (automatic)</td>
      <td>98.80</td>
      <td>2807.10</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>1304-NECVQ</td>
      <td>Female</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>78.55</td>
      <td>149.55</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>7153-CHRBV</td>
      <td>Female</td>
      <td>0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>DSL</td>
      <td>Yes</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>One year</td>
      <td>Yes</td>
      <td>Mailed check</td>
      <td>59.30</td>
      <td>3274.35</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>I’m redefining feature types and our preprocessor for our sanity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">,</span> <span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;customerID&quot;</span><span class="p">,</span> <span class="s2">&quot;tenure&quot;</span><span class="p">]</span>
<span class="n">passthrough_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span>
<span class="n">target_column</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="c1"># the rest are categorical</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">passthrough_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">drop_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">target_column</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()),</span>
        <span class="n">numeric_features</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">numeric_features</span>
    <span class="o">+</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
    <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">passthrough_features</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">lr_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">new_columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Contract_Month-to-month</th>
      <td>0.787653</td>
    </tr>
    <tr>
      <th>InternetService_Fiber optic</th>
      <td>0.600509</td>
    </tr>
    <tr>
      <th>OnlineSecurity_No</th>
      <td>0.291008</td>
    </tr>
    <tr>
      <th>StreamingTV_Yes</th>
      <td>0.258659</td>
    </tr>
    <tr>
      <th>PaymentMethod_Electronic check</th>
      <td>0.251646</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>MultipleLines_No</th>
      <td>-0.169654</td>
    </tr>
    <tr>
      <th>PaymentMethod_Credit card (automatic)</th>
      <td>-0.204406</td>
    </tr>
    <tr>
      <th>InternetService_DSL</th>
      <td>-0.461593</td>
    </tr>
    <tr>
      <th>TotalCharges</th>
      <td>-0.743315</td>
    </tr>
    <tr>
      <th>Contract_Two year</th>
      <td>-0.765519</td>
    </tr>
  </tbody>
</table>
<p>44 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>There is some agreement, which is good.</p></li>
<li><p>But our survival model is much more useful.</p>
<ul>
<li><p>Not to mention more correct.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>One thing we get with <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> is confidence intervals on the coefficients:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">cph</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_147_0.png" src="../_images/19_survival-analysis_147_0.png" />
</div>
</div>
<ul class="simple">
<li><p>(We could probably get the same for logistic regression if using <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> instead of sklearn.)</p></li>
<li><p>However, in general, I would be careful with all of this.</p></li>
<li><p>Ideally we would have more statistical training when using <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> - there is a lot that can go wrong.</p>
<ul>
<li><p>It comes with various diagnostics as well.</p></li>
</ul>
</li>
<li><p>But I think it’s very useful to know about survival analysis and the availability of software to deal with it.</p></li>
<li><p>Oh, and there are lots of other nice plots.</p></li>
</ul>
<ul class="simple">
<li><p>Let’s look at the survival plots for the people with</p>
<ul>
<li><p>two-year contract (Contract_Two year = 1) and</p></li>
<li><p>people without two-year contract (Contract_Two year = 0)</p></li>
</ul>
</li>
<li><p>As expected, the former survive longer.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">plot_partial_effects_on_outcome</span><span class="p">(</span><span class="s2">&quot;Contract_Two year&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_150_0.png" src="../_images/19_survival-analysis_150_0.png" />
</div>
</div>
<p>Now let’s look at the survival plots for the people with different MonthlyCharges.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">plot_partial_effects_on_outcome</span><span class="p">(</span><span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_152_0.png" src="../_images/19_survival-analysis_152_0.png" />
</div>
</div>
<ul class="simple">
<li><p>That’s the thing with linear models, they can’t stop the growth.</p></li>
<li><p>We have a negative coefficient associated with <code class="docutils literal notranslate"><span class="pre">MonthlyCharges</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>coef   -0.003185
Name: MonthlyCharges, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>If your monthly charges are huge, it takes this to the extreme and thinks you’ll basically never churn.</p>
<p><br><br><br><br></p>
</div>
<div class="section" id="prediction-10-min">
<h2>Prediction (10 min)<a class="headerlink" href="#prediction-10-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>We can use survival analysis to make predictions as well.</p></li>
<li><p>Here is the expected number of months to churn for the first 5 customers in the test set:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df_surv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SeniorCitizen</th>
      <th>MonthlyCharges</th>
      <th>StreamingMovies_No</th>
      <th>StreamingMovies_No internet service</th>
      <th>StreamingMovies_Yes</th>
      <th>Partner_No</th>
      <th>Partner_Yes</th>
      <th>OnlineSecurity_No</th>
      <th>OnlineSecurity_No internet service</th>
      <th>OnlineSecurity_Yes</th>
      <th>...</th>
      <th>PhoneService_No</th>
      <th>PhoneService_Yes</th>
      <th>OnlineBackup_No</th>
      <th>OnlineBackup_No internet service</th>
      <th>OnlineBackup_Yes</th>
      <th>PaperlessBilling_No</th>
      <th>PaperlessBilling_Yes</th>
      <th>DeviceProtection_No</th>
      <th>DeviceProtection_No internet service</th>
      <th>DeviceProtection_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>941</th>
      <td>0.0</td>
      <td>-1.154900</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1404</th>
      <td>0.0</td>
      <td>-1.383246</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5515</th>
      <td>0.0</td>
      <td>-1.514920</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3684</th>
      <td>0.0</td>
      <td>0.351852</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>7017</th>
      <td>0.0</td>
      <td>-1.471584</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 43 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df_surv</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Churn</th>
      <th>tenure</th>
      <th>SeniorCitizen</th>
      <th>MonthlyCharges</th>
      <th>StreamingMovies_No</th>
      <th>StreamingMovies_No internet service</th>
      <th>StreamingMovies_Yes</th>
      <th>Partner_No</th>
      <th>Partner_Yes</th>
      <th>OnlineSecurity_No</th>
      <th>...</th>
      <th>PhoneService_No</th>
      <th>PhoneService_Yes</th>
      <th>OnlineBackup_No</th>
      <th>OnlineBackup_No internet service</th>
      <th>OnlineBackup_Yes</th>
      <th>PaperlessBilling_No</th>
      <th>PaperlessBilling_Yes</th>
      <th>DeviceProtection_No</th>
      <th>DeviceProtection_No internet service</th>
      <th>DeviceProtection_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>941</th>
      <td>0.0</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>-1.154900</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1404</th>
      <td>0.0</td>
      <td>35.0</td>
      <td>0.0</td>
      <td>-1.383246</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5515</th>
      <td>0.0</td>
      <td>18.0</td>
      <td>0.0</td>
      <td>-1.514920</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3684</th>
      <td>0.0</td>
      <td>43.0</td>
      <td>0.0</td>
      <td>0.351852</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>7017</th>
      <td>0.0</td>
      <td>51.0</td>
      <td>0.0</td>
      <td>-1.471584</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 45 columns</p>
</div></div></div>
</div>
<p>How long each non-churned customer is likely to stay according to the model assuming that they just joined right now?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_expectation</span><span class="p">(</span><span class="n">test_df_surv</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>  <span class="c1"># assumes they just joined right now</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>941     35.206731
1404    69.023078
5515    68.608555
3684    27.565069
7017    67.890922
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Survival curves for first 5 customers in the test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">test_df_surv</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_164_0.png" src="../_images/19_survival-analysis_164_0.png" />
</div>
</div>
<p>From <code class="docutils literal notranslate"><span class="pre">predict_survival_function</span></code> documentation:</p>
<blockquote>
<div><p>Predict the survival function for individuals, given their covariates. This assumes that the individual just entered the study (that is, we do not condition on how long they have already lived for.)</p>
</div></blockquote>
<p>So these curves are “starting now”.</p>
<ul class="simple">
<li><p>There’s no probability prerequisite for this course, so this is optional material.</p></li>
<li><p>But you can do some interesting stuff here with conditional probabilities.</p></li>
<li><p>“Given that a customer has been here 5 months, what’s the outlook?”</p>
<ul>
<li><p>It will be different than for a new customer.</p></li>
<li><p>Thus, we might still want to predict for the non-churned customers in the training set!</p></li>
<li><p>Not something we really thought about with our traditional supervised learning.</p></li>
</ul>
</li>
</ul>
<p>Let’s get the customers who have not churned yet.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_surv_not_churned</span> <span class="o">=</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can <em>condition</em> on the person having been around for 20 months.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">conditional_after</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>6464</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>0.996788</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>0.991966</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>0.989443</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>0.982570</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>68.0</th>
      <td>0.429635</td>
    </tr>
    <tr>
      <th>69.0</th>
      <td>0.429635</td>
    </tr>
    <tr>
      <th>70.0</th>
      <td>0.429635</td>
    </tr>
    <tr>
      <th>71.0</th>
      <td>0.429635</td>
    </tr>
    <tr>
      <th>72.0</th>
      <td>0.429635</td>
    </tr>
  </tbody>
</table>
<p>73 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span>
    <span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">conditional_after</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">20</span><span class="p">:],</span> <span class="n">preds</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Starting now&quot;</span><span class="p">,</span> <span class="s2">&quot;Given 20 more months of service&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_171_0.png" src="../_images/19_survival-analysis_171_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Look at how the survival function (and expected lifetime) is much longer <em>given</em> that the customer has already lasted 20 months.</p></li>
</ul>
<ul class="simple">
<li><p>How long each non-churned customer is likely to stay according to the model assuming that they have been here for the tenure time?</p></li>
<li><p>So, we can set this to their actual tenure so far to get a prediciton of what will happen going forward:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span>
    <span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">conditional_after</span><span class="o">=</span><span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tenure&quot;</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time into the future (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_174_0.png" src="../_images/19_survival-analysis_174_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Another useful application: you could ask what is the <a class="reference external" href="https://en.wikipedia.org/wiki/Customer_lifetime_value">customer lifetime value</a>.</p>
<ul>
<li><p>Basically, how much money do you expect to make off this customer between now and when they churn?</p></li>
</ul>
</li>
<li><p>With regular supervised learning, tenure was a feature and we could only predict whether or not they had churned by then.</p></li>
</ul>
</div>
<div class="section" id="evaluation">
<h2>Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this headline">¶</a></h2>
<p>By default score returns “partial log likelihood”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.8641864810547806
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_df_surv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.7277855153568582
</pre></div>
</div>
</div>
</div>
<p>We can look at the “concordance index” which is more interpretable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">concordance_index_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8625886620148505
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">,</span> <span class="n">scoring_method</span><span class="o">=</span><span class="s2">&quot;concordance_index&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8625886620148505
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_df_surv</span><span class="p">,</span> <span class="n">scoring_method</span><span class="o">=</span><span class="s2">&quot;concordance_index&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8546143543902771
</pre></div>
</div>
</div>
</div>
<p>From the documentation <a class="reference external" href="https://lifelines.readthedocs.io/en/latest/Survival%20Regression.html#model-selection-and-calibration-in-survival-regression">here</a>:</p>
<blockquote>
<div><p>Another censoring-sensitive measure is the concordance-index, also known as the c-index. This measure evaluates the accuracy of the ranking of predicted time. It is in fact a generalization of AUC, another common loss function, and is interpreted similarly:</p>
<ul class="simple">
<li><p>0.5 is the expected result from random predictions,</p></li>
<li><p>1.0 is perfect concordance and,</p></li>
<li><p>0.0 is perfect anti-concordance (multiply predictions with -1 to get 1.0)</p></li>
</ul>
<p><a class="reference external" href="https://stats.stackexchange.com/a/478305/11867">Here</a> is an excellent introduction &amp; description of the c-index for new users.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cph.log_likelihood_ratio_test()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cph.check_assumptions(df_train_surv)</span>
</pre></div>
</div>
</div>
</div>
<p><br><br><br><br></p>
</div>
<div class="section" id="other-approaches-what-did-we-not-cover-5-min">
<h2>Other approaches / what did we not cover? (5 min)<a class="headerlink" href="#other-approaches-what-did-we-not-cover-5-min" title="Permalink to this headline">¶</a></h2>
<p>There are many other approaches to modelling in survival analysis:</p>
<ul class="simple">
<li><p>Time-varying proportional hazards.</p>
<ul>
<li><p>What if some of the features change over time, e.g. plan type, number of lines, etc.</p></li>
</ul>
</li>
<li><p>Approaches based on deep learning, e.g. the <a class="reference external" href="https://square.github.io/pysurvival/">pysurvival</a> package.</p></li>
<li><p>Random survival forests.</p></li>
<li><p>And more…</p></li>
</ul>
<div class="section" id="types-of-censoring">
<h3>Types of censoring<a class="headerlink" href="#types-of-censoring" title="Permalink to this headline">¶</a></h3>
<p>There are also various types and sub-types of censoring we didn’t cover:</p>
<ul class="simple">
<li><p>What we did today is called “right censoring”</p></li>
<li><p>Sub-types within right censoring</p>
<ul>
<li><p>Did everyone join at the same time?</p></li>
<li><p>Other there other reasons the data might be censored at random times, e.g. the person died?</p></li>
</ul>
</li>
<li><p>Left censoring</p></li>
<li><p>Interval censoring</p></li>
</ul>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Censoring and incorrect approaches to handling it</p>
<ul>
<li><p>Throw away people who haven’t churned</p></li>
<li><p>Assume everyone churns today</p></li>
</ul>
</li>
<li><p>Predicting tenure vs. churned</p></li>
<li><p>Survival analysis encompasses both of these, and deals with censoring</p></li>
<li><p>And it can make rich and interesting predictions!</p></li>
<li><p>KM model -&gt; doesn’t look at features</p></li>
<li><p>CPH model -&gt; like linear regression, does look at the features</p></li>
</ul>
</div>
<div class="section" id="true-false-questions">
<h2>True/False questions<a class="headerlink" href="#true-false-questions" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>If all customers joined a service at the same time (hypothetically), then censoring would not be an issue.</p></li>
<li><p>The Cox proportional hazards model (<code class="docutils literal notranslate"><span class="pre">cph</span></code> above) assumes the effect of a feature is the same for all customers and over all time.</p></li>
<li><p>Survival analysis can be useful even without a “deployment” stage.</p></li>
</ol>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p>Some people working with this same dataset:</p>
<ul class="simple">
<li><p>https://medium.com/&#64;zachary.james.angell/applying-survival-analysis-to-customer-churn-40b5a809b05a</p></li>
<li><p>https://towardsdatascience.com/churn-prediction-and-prevention-in-python-2d454e5fd9a5 (Cox)</p></li>
<li><p>https://towardsdatascience.com/survival-analysis-in-python-a-model-for-customer-churn-e737c5242822</p></li>
<li><p>https://towardsdatascience.com/survival-analysis-intuition-implementation-in-python-504fde4fcf8e</p></li>
</ul>
<p>lifelines documentation:</p>
<ul class="simple">
<li><p>https://lifelines.readthedocs.io/en/latest/Survival%20analysis%20with%20lifelines.html</p></li>
<li><p>https://lifelines.readthedocs.io/en/latest/Survival%20Analysis%20intro.html#introduction-to-survival-analysis</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-cpsc330-py"
        },
        kernelOptions: {
            kernelName: "conda-env-cpsc330-py",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-cpsc330-py'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="18_time-series.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Lecture 18: Time series</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="20_ethics.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 20: Ethics</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Varada Kolhatkar<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>